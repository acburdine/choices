<!doctype html>
<html>
    <head>
        <title>Choices | A game about life's choices.</title>
        
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        
        <style>
            body {
                background-color: black;
                color: white;
                font-size: 24px;
                font-family: 'Open Sans', sans-serif;
                padding: 5px;
            }
            
            .scroll-options,
            .scroll-options:before,
            .scroll-options:after {
                user-select: none;
                -moz-user-select: none;
                -webkit-user-select: none;
                -ms-user-select: none;
            }
            
            .scroll-options > .scroll-option {
                display: inline;
                margin-right: 40px;
            }
            
            label, .scroll-speed {
                font-size: 12px;
            }
            
            .main-text {
                margin-top: 50px;
                margin-left: auto;
                margin-right: auto;
                width: 850px;
            }
            
            #solo {
                text-align: center;
            }
            
            #list {
                margin-left: auto;
                margin-right: auto;
                text-align: center;
                list-style-position: inside;
                list-style-type: upper-latin;
            }
            
            .choice {
                text-align: center;
            }
            
            .choice:hover {
                font-weight: bold;
                cursor: pointer;
            }
        </style>
        
        <script type="text/javascript" src="//code.jquery.com/jquery-1.11.3.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
    </head>
    <body>
        <div class="scroll-options">
            <div class="scroll-option">
                <label for="scroll">Enable Scrolling Text</label>
                <input type="checkbox" id="scroll" checked="checked">
            </div>
            <div class="scroll-speed scroll-option">
                <label for="scroll-speed">Scrolling Speed</label>
                <select id="scroll-speed">
                    <option value="90">Slow</option>
                    <option value="60" selected="selected">Medium</option>
                    <option value="30">Fast</option>
                </select>
            </div>
        </div>
        
        <div class="js-text main-text"></div>
        
        <br><br>
        
        <ol id="list">
            
        </ol>
        
        <div id="solo"></div>
        
        <script type="text/javascript" src="story.js"></script>
        <script type="text/javascript">
            var shouldScroll = $('#scroll').prop('checked'),
                scrollSpeed = parseInt($('#scroll-speed').val());
            
            function showText(target, message, index, cb) {
                var interval = scrollSpeed || 60;
                
                if (!shouldScroll) {
                    message = message.replace(/\\/g, '<br>');
                    message = message.replace(/\//g, '\'');
                    $(target).html(message);
                    cb();
                    return;
                }
                
                if (index < message.length) {
                    var i = message[index++];
                    
                    if (/\\/.test(i)) {
                        i = '<br>';
                    }
                    
                    if (/\//.test(i)) {
                        i = '\'';
                    }
                    
                    $(target).html($(target).html() + i);
                    setTimeout(function () {
                        showText(target, message, index, cb);
                    }, interval);
                } else {
                    cb();
                }
            }
            
            function renderScenario(index) {
                var data = storyData[index],
                    message = data.message,
                    proceed = data.proceed;
                
                if (_.isFunction(message)) {
                    message = message();
                }
                
                if (_.isFunction(proceed)) {
                    proceed = proceed();
                }
                
                ss.setItem('step', index);
                
                showText('.js-text', message, 0, function () {
                    if (_.isArray(proceed)) {
                        for (var i in proceed) {
                            var j = proceed[i];
                            
                            $('#list').append($('<li>').html(j.msg).data('next', j.next).addClass('choice js-choice'));
                        }
                        $('#list').show();
                    } else {
                        $('#solo').append($('<span>').html(proceed.msg).data('next', proceed.next).addClass('choice js-choice')).show();
                    }
                });
            }
            
            $(document).ready(function () {
                var initialIndex = (ss.getItem('step')) ? ss.getItem('step') : 0;
                
                renderScenario(initialIndex);

                $('#solo, #list').on('click', '.js-choice', function (event) {
                    var next = $(this).data('next');

                    event.preventDefault();

                    $('#solo').html('').hide();
                    $('#list').html('').hide();
                    $('.js-text').html('');
                    
                    if (_.isFunction(next)) {
                        next = next();
                    }
                    
                    if (_.isObject(next)) {
                        $('#list').html('').hide();
                        $('.js-text').html('');
                        
                        showText('.js-text', next.response, 0, function () {
                            $('#solo').html('').append($('<span>').html('Next').data('next', next.next).addClass('choice js-choice')).show();
                        });
                    } else {
                        renderScenario(next);   
                    }
                });
                
                $('#scroll').change(function () {
                    shouldScroll = $(this).prop('checked');
                    
                    if (!shouldScroll) {
                        $('.scroll-speed').hide();
                    } else {
                        $('.scroll-speed').show();
                    }
                });
                
                $('#scroll-speed').change(function () {
                    scrollSpeed = parseInt($(this).val());
                });
            });
        </script>
    </body>
</html>